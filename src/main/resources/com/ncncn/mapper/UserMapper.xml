<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ncncn.mapper.UserMapper">

    <select id="readByEmail" resultType="com.ncncn.domain.UserVO">
        select *
        from user
        where email = #{email}
    </select>

    <insert id="insert">
        insert into user(email, pwd, name, tel_no, eml_auth_tkn, in_user, up_user)
            value (#{email}, #{pwd}, #{name}, #{telNo}, #{emlAuthTkn}, current_user , current_user)
    </insert>

    <delete id="deleteByEmail">
        delete
        from user
        where email = #{email}
    </delete>


    <!-- LOGIN -->
    <select id="readForLogin" resultType="com.ncncn.domain.UserVO">
        select email,
               pwd,
               userT.enabled,
               roleT.code_name as roleCode
        from (
                 select email, pwd, enabled, role_code
                 from user
                 where email = #{email}
             ) userT,
             (
                 select *
                 from cmmn_code
                 where code_type = "USER_ROLE"
             ) roleT
        where userT.role_code = roleT.code
        ;
    </select>


    <select id="readById" resultType="com.ncncn.domain.UserVO">
        select *
        from user
        where id = #{userId};
    </select>

    <!-- 3일 전부터 새로 가입한 사용자를 카운트한다. -->
    <select id="countRecentlyInsert" resultType="int">
        select count(*) from user where in_date between date_sub(curdate(), interval 3 day) and date_add(curdate(), interval 1 day)
    </select>

    <select id="getMyInfo" resultType="com.ncncn.domain.UserInfoDTO">

            <![CDATA[
        select user.id,
               user.email,
               user.pwd,
               user.name,
               user.tel_no,
               bnkT.acc,
               bnkT.bnk_code,
               bnkT.holder,
               bnkT.is_authed,
               stusT.code_name
        from
            (
                bank_account bnkT
                    left join
                        (select * from cmmn_code where code_type = 'BANK_NAME' and enabled = 1) stusT
                    on bnkT.bnk_code = stusT.code
                )
                right join
                (select * from user where user.id = #{userId} and enabled = '1') user
        on user.id = bnkT.user_Id
        ]]>

     </select>

</mapper>